<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet id="Create sequences" author="Liquibase" runAlways="true" failOnError="false">
        <createSequence sequenceName="COUNTRY_SEQUENCE" startValue="1" cacheSize="0"/>
        <createSequence sequenceName="FEATURE_SEQUENCE" startValue="1" cacheSize="0"/>
        <createSequence sequenceName="HOTEL_SEQUENCE" startValue="1" cacheSize="0"/>
        <createSequence sequenceName="USER_SEQUENCE" startValue="1" cacheSize="0"/>
        <createSequence sequenceName="TOUR_SEQUENCE" startValue="1" cacheSize="0"/>
        <createSequence sequenceName="REVIEW_SEQUENCE" startValue="1" cacheSize="0"/>
    </changeSet>

    <changeSet id="Create tables" author="Liquibase" runAlways="true" failOnError="false">
        <!--_____________________________________________________COUNTRY_____________________________________________________-->
        <createTable tableName="COUNTRIES">
            <column name="COUNTRY_ID" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="COUNTRY_PK"/>
            </column>
            <column name="NAME" type="VARCHAR">
                <constraints nullable="false" checkConstraint="CHECK (LENGTH(NAME) &gt; 3)" unique="true"/>
            </column>
        </createTable>
        <!--_____________________________________________________COUNTRY_____________________________________________________-->
		
        <!--_____________________________________________________FEATURE_____________________________________________________-->
        <createTable tableName="FEATURES">
            <column name="FEATURE_ID" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="FEATURE_PK"/>
            </column>
            <column name="NAME" type="VARCHAR">
                <constraints nullable="false" checkConstraint="CHECK (LENGTH(NAME) &gt; 3)" unique="true"/>
            </column>
        </createTable>
        <!--_____________________________________________________FEATURE_____________________________________________________-->
		
        <!--______________________________________________________HOTEL______________________________________________________-->
        <createTable tableName="HOTELS">
            <column name="HOTEL_ID" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="HOTEL_PK"/>
            </column>
            <column name="NAME" type="VARCHAR">
                <constraints nullable="false" checkConstraint="CHECK (LENGTH(NAME) &gt; 3)" unique="true"/>
            </column>
            <column name="STARS" type="SMALLINT">
                <constraints nullable="false" checkConstraint="CHECK (STARS &gt; 0 AND STARS &lt; 6)"/>
            </column>
            <column name="WEBSITE" type="VARCHAR">
                <constraints checkConstraint="CHECK (LENGTH(NAME) &gt; 3 AND REGEXP_INSTR(WEBSITE, 'https?\:\/\/www\.\w+\.[a-z]{2,3}($|\/[\w\/\-]+\/$)') &gt; 0)" unique="true"/>
            </column>
            <column name="LATITUDE" type="BIGINT(9,7)">
                <constraints nullable="false" checkConstraint="CHECK (LATITUDE &gt; -90.0000000 AND LATITUDE &lt; 90.0000000)"/>
            </column>
            <column name="LONGITUDE" type="BIGINT(10,7)">
                <constraints nullable="false" checkConstraint="CHECK (LONGITUDE &gt; -180.0000000 AND LONGITUDE &lt; 180.0000000)"/>
            </column>
        </createTable>
        <!--______________________________________________________HOTEL______________________________________________________-->
		
        <!--__________________________________________________HOTEL_FEATURE__________________________________________________-->
        <createTable tableName="HOTELS_FEATURES">
            <column name="HOTEL_ID" type="BIGINT">
                <constraints nullable="false" foreignKeyName="HOTEL_FEATURE_HOTEL_ID_FK"/>
            </column>
            <column name="FEATURE_ID" type="BIGINT">
                <constraints nullable="false" foreignKeyName="HOTEL_FEATURE_FEATURE_ID_FK"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="HOTELS_FEATURES" columnNames="HOTEL_ID, FEATURE_ID"/>
        <addForeignKeyConstraint baseTableName="HOTEL_FEATURE" baseColumnNames="HOTEL_ID"
                                 constraintName="HOTEL_FEATURE_HOTEL_ID_FK" referencedTableName="HOTEL"
                                 referencedColumnNames="HOTEL_ID"/>
        <addForeignKeyConstraint baseTableName="HOTEL_FEATURE" baseColumnNames="FEATURE_ID"
                                 constraintName="HOTEL_FEATURE_FEATURE_ID_FK" referencedTableName="FEATURE"
                                 referencedColumnNames="FEATURE_ID"/>
        <!--__________________________________________________HOTEL_FEATURE__________________________________________________-->
		
        <!--______________________________________________________USER_______________________________________________________-->
        <createTable tableName="USERS">
            <column name="USER_ID" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="USER_PK"/>
            </column>
            <column name="LOGIN" type="VARCHAR">
                <constraints nullable="false" checkConstraint="CHECK (LENGTH(LOGIN) &gt; 4)" unique="true"/>
            </column>
            <column name="PASSWORD" type="VARCHAR">
                <constraints nullable="false" checkConstraint="CHECK (LENGTH(PASSWORD) &gt; 4)"  unique="true"/>
            </column>
            <column name="ROLE" type="VARCHAR" defaultValue="USER">
                <constraints nullable="false" checkConstraint="CHECK (LENGTH(ROLE) &gt; 3 AND ROLE IN ('USER', 'ADMIN'))"/>
            </column>
        </createTable>
        <!--______________________________________________________USER_______________________________________________________-->
		
        <!--______________________________________________________TOUR_______________________________________________________-->
        <createTable tableName="TOURS">
            <column name="TOUR_ID" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="TOUR_PK"/>
            </column>
            <column name="PHOTO_PATH" type="NVARCHAR"/>
            <column name="START_DATE" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="END_DATE" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="DESCRIPTION" type="NVARCHAR"/>
            <column name="COST" type="CURRENCY">
                <constraints nullable="false" checkConstraint="CHECK (COST &gt; 0.0000)"/>
            </column>
            <column name="TOUR_TYPE" type="VARCHAR">
                <constraints nullable="false" checkConstraint="CHECK(TOUR_TYPE IN ('BUSINESS', 'ECOTOURISM', 'LEISURE',
                 'PILGRIMAGE', 'RURAL_TOURISM', 'SCIENTIFIC_EXPEDITION', 'SPORT_COMPETITION', 'TOURISM', 'TRAINING', 'TREATMENT')"/>
            </column>
            <column name="HOTEL_ID" type="BIGINT">
                <constraints foreignKeyName="TOUR_HOTEL_ID_FK"/>
            </column>
            <column name="COUNTRY_ID" type="BIGINT">
                <constraints foreignKeyName="TOUR_COUNTRY_ID_FK"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="TOURS" baseColumnNames="HOTEL_ID" constraintName="TOUR_HOTEL_ID_FK"
                                 referencedTableName="HOTELS" referencedColumnNames="HOTEL_ID"/>
        <addForeignKeyConstraint baseTableName="TOURS" baseColumnNames="COUNTRY_ID" constraintName="TOUR_COUNTRY_ID_FK"
                                 referencedTableName="COUNTRIES" referencedColumnNames="COUNTRY_ID"/>
        <!--______________________________________________________TOUR_______________________________________________________-->
		
        <!--____________________________________________________USER_TOUR____________________________________________________-->
        <createTable tableName="USERS_TOURS">
            <column name="USER_ID" type="BIGINT">
                <constraints nullable="false" foreignKeyName="USER_TOUR_USER_ID_FK"/>
            </column>
            <column name="TOUR_ID" type="BIGINT">
                <constraints nullable="false" foreignKeyName="USER_TOUR_TOUR_ID_FK"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="USERS_TOURS" columnNames="USER_ID, TOUR_ID"/>
        <addForeignKeyConstraint baseTableName="USERS_TOURS" baseColumnNames="USER_ID" constraintName="USER_TOUR_USER_ID_FK"
                                 referencedTableName="USERS" referencedColumnNames="USER_ID"/>
        <addForeignKeyConstraint baseTableName="USERS_TOURS" baseColumnNames="TOUR_ID" constraintName="USER_TOUR_TOUR_ID_FK"
                                 referencedTableName="TOURS" referencedColumnNames="TOUR_ID"/>
        <!--____________________________________________________USER_TOUR____________________________________________________-->
		
		<!--______________________________________________________REVIEW_____________________________________________________-->
        <createTable tableName="REVIEWS">
            <column name="REVIEW_ID" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="REVIEW_PK"/>
            </column>
            <column name="REVIEW_DATE" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="REVIEW_TEXT" type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="USER_ID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="TOUR_ID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="REVIEWS" baseColumnNames="USER_ID" constraintName="REVIEW_USER_ID_FK"
                                 referencedTableName="USERS" referencedColumnNames="USER_ID"/>
        <addForeignKeyConstraint baseTableName="REVIEWS" baseColumnNames="TOUR_ID" constraintName="REVIEW_TOUR_ID_FK"
                                 referencedTableName="TOURS" referencedColumnNames="TOUR_ID"/>
		<!--______________________________________________________REVIEW_____________________________________________________-->
    </changeSet>

</databaseChangeLog>